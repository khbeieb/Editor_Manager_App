
<div class="author-list-container">
  <p-toast data-testid="toast-messages"></p-toast>

  <div class="list-wrapper">
    <!-- Header Section -->
    <div class="header-section">
      <p-card
        styleClass="header-card"
        data-testid="header-card"
      >
        <div class="header-content">
          <div class="title-section">
            <h1 class="page-title" data-testid="authors-title">
              <i class="pi pi-users"></i>
              Authors Library
            </h1>
            <p class="page-subtitle">
              Manage and explore our collection of authors and their published works
            </p>
          </div>

          <div class="header-actions">
            <button
              pButton
              type="button"
              label="Add New Author"
              icon="pi pi-plus"
              class="p-button-primary add-author-btn"
              routerLink="/authors/new"
              data-testid="add-author-button"
            ></button>

            <button
              pButton
              type="button"
              icon="pi pi-refresh"
              class="p-button-outlined refresh-btn"
              (click)="refreshAuthors()"
              [loading]="isRefreshing"
              pTooltip="Refresh authors list"
              tooltipPosition="bottom"
              data-testid="refresh-authors-button"
              [attr.data-refreshing]="isRefreshing"
            ></button>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <p-card
        header="Search & Filter"
        styleClass="filters-card"
        data-testid="filters-card"
      >
        <div class="filters-grid">
          <div class="filter-field">
            <label for="search-input">Search Authors</label>
            <input
              pInputText
              id="search-input"
              [(ngModel)]="filters.searchTerm"
              (ngModelChange)="onFilterChange()"
              placeholder="Search by name or nationality..."
              class="search-input"
              data-testid="search-input"
              [attr.data-search-term]="filters.searchTerm"
            />
            <i class="pi pi-search search-icon"></i>
          </div>

          <div class="filter-field">
            <label for="nationality-filter">Filter by Nationality</label>
            <p-select
              id="nationality-filter"
              [(ngModel)]="filters.nationalityFilter"
              (ngModelChange)="onFilterChange()"
              [options]="nationalityOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="All Nationalities"
              styleClass="nationality-dropdown"
              data-testid="nationality-filter"
              [attr.data-nationality-filter]="filters.nationalityFilter"
            ></p-select>
          </div>

          <div class="filter-field">
            <label for="sort-by">Sort By</label>
            <p-select
              id="sort-by"
              [(ngModel)]="filters.sortBy"
              (ngModelChange)="onFilterChange()"
              [options]="sortOptions"
              optionLabel="label"
              optionValue="value"
              styleClass="sort-dropdown"
              data-testid="sort-by-filter"
              [attr.data-sort-by]="filters.sortBy"
            ></p-select>
          </div>

          <div class="filter-field">
            <label for="sort-order">Sort Order</label>
            <p-select
              id="sort-order"
              [(ngModel)]="filters.sortOrder"
              (ngModelChange)="onFilterChange()"
              [options]="sortOrderOptions"
              optionLabel="label"
              optionValue="value"
              styleClass="sort-order-dropdown"
              data-testid="sort-order-filter"
              [attr.data-sort-order]="filters.sortOrder"
            ></p-select>
          </div>
        </div>

        <div class="filter-summary" *ngIf="hasActiveFilters()" data-testid="filter-summary">
              <span class="summary-text">
                <i class="pi pi-filter"></i>
                Showing {{ (filteredAuthors$ | async)?.length || 0 }} of {{ (authors$ | async)?.data?.length || 0 }} authors
              </span>
          <button
            pButton
            type="button"
            label="Clear Filters"
            icon="pi pi-times"
            class="p-button-sm p-button-outlined clear-filters-btn"
            (click)="clearFilters()"
            data-testid="clear-filters-button"
          ></button>
        </div>
      </p-card>
    </div>

    <!-- Authors Table Section -->
    <div class="table-section">
      <p-card
        styleClass="table-card"
        data-testid="authors-table-card"
      >
        <!-- Loading State -->
        <div
          class="loading-container"
          *ngIf="isLoading"
          data-testid="loading-spinner"
        >
          <p-progressSpinner
            [style]="{width: '50px', height: '50px'}"
            strokeWidth="4"
            animationDuration="1s"
          ></p-progressSpinner>
          <p class="loading-text">Loading authors...</p>
        </div>

        <!-- Error State -->
        <div
          class="error-container"
          *ngIf="hasError && !isLoading"
          data-testid="error-message"
        >
          <i class="pi pi-exclamation-triangle error-icon"></i>
          <h3>Failed to Load Authors</h3>
          <p>We couldn't retrieve the authors list. Please try again.</p>
          <button
            pButton
            type="button"
            label="Retry"
            icon="pi pi-refresh"
            class="p-button-outlined"
            (click)="refreshAuthors()"
            data-testid="retry-button"
          ></button>
        </div>

        <!-- Authors Table -->
        <div *ngIf="!isLoading && !hasError" class="table-container">
          <div class="table-header">
            <h3 class="table-title">
              <i class="pi pi-list"></i>
              Authors Directory
              <span class="authors-count" data-testid="authors-count">
                    ({{ (filteredAuthors$ | async)?.length || 0 }})
                  </span>
            </h3>
          </div>

          <p-table
            [value]="(filteredAuthors$ | async) ?? []"
            [responsiveLayout]="'scroll'"
            styleClass="authors-table"
            data-testid="authors-table"
            [attr.data-authors-count]="(filteredAuthors$ | async)?.length"
          >
            <ng-template pTemplate="header">
              <tr>
                <th class="author-name-col">Author</th>
                <th class="nationality-col">Nationality</th>
                <th class="birth-date-col">Birth Date</th>
                <th class="books-col">Published Books</th>
                <th class="actions-col">Actions</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-author let-i="rowIndex">
              <tr
                class="author-row"
                [attr.data-testid]="'author-row-'+ i "
                [attr.data-author-id]="author.id"
                [attr.data-author-name]="author.name"
              >
                <td class="author-name-cell">
                  <div class="author-info">
                    <div class="author-avatar">
                      <i class="pi pi-user"></i>
                    </div>
                    <div class="author-details">
                          <span
                            class="author-name"
                            [attr.data-testid]="'author-name-'+ i "
                          >
                            {{ author.name }}
                          </span>
                      <small class="author-id">ID: {{ author.id }}</small>
                    </div>
                  </div>
                </td>

                <td class="nationality-cell">
                  <p-tag
                    [value]="author.nationality"
                    [style]="{background: getNationalityColor(author.nationality)}"
                    [attr.data-testid]="'author-nationality-'+ i "
                  ></p-tag>
                </td>

                <td class="birth-date-cell">
                      <span
                        class="birth-date"
                        [attr.data-testid]="'author-birth-date-'+ i "
                      >
                        {{ author.birthDate | date: 'mediumDate' }}
                      </span>
                  <small class="age-info">
                    ({{ calculateAge(author.birthDate) }} years old)
                  </small>
                </td>

                <td class="books-cell">
                  <div class="books-info">
                    <div class="books-count">
                      <i class="pi pi-book"></i>
                      <span
                        class="count-badge"
                        [attr.data-testid]="'author-books-count-'+ i "
                      >
                            {{ author.books?.length || 0 }}
                          </span>
                    </div>

                    <div
                      class="books-list"
                      *ngIf="author.books?.length; else noBooksTemplate"
                      [attr.data-testid]="'author-books-list-'+ i "
                    >
                      <div
                        class="book-item"
                        *ngFor="let book of author.books; let bookIndex = index"
                        [attr.data-testid]="'book-item--'+ i +'-'+ bookIndex "
                      >
                        <div class="book-title">{{ book.title }}</div>
                        <div class="book-isbn">ISBN: {{ book.isbn }}</div>
                        <div class="book-date">
                          <i class="pi pi-calendar"></i>
                          {{ book.publicationDate | date: 'yyyy' }}
                        </div>
                      </div>
                    </div>

                    <ng-template #noBooksTemplate>
                      <div
                        class="no-books"
                        [attr.data-testid]="'no-books-'+ i "
                      >
                        <i class="pi pi-info-circle"></i>
                        <span>No published books</span>
                      </div>
                    </ng-template>
                  </div>
                </td>

                <td class="actions-cell">
                  <div class="action-buttons">
                    <button
                      pButton
                      type="button"
                      icon="pi pi-eye"
                      class="p-button-rounded p-button-outlined p-button-sm view-btn"
                      (click)="viewAuthor(author)"
                      pTooltip="View details"
                      tooltipPosition="top"
                      [attr.data-testid]="'view-author-button-'+ i "
                      [attr.data-author-id]="author.id"
                    ></button>

                    <button
                      pButton
                      type="button"
                      icon="pi pi-pencil"
                      class="p-button-rounded p-button-outlined p-button-sm edit-btn"
                      (click)="editAuthor(author)"
                      pTooltip="Edit author"
                      tooltipPosition="top"
                      [attr.data-testid]="'edit-author-button-'+ i "
                      [attr.data-author-id]="author.id"
                    ></button>

                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      class="p-button-rounded p-button-outlined p-button-sm p-button-danger delete-btn"
                      (click)="deleteAuthor(author)"
                      pTooltip="Delete author"
                      tooltipPosition="top"
                      [attr.data-testid]="'delete-author-button-'+ i "
                      [attr.data-author-id]="author.id"
                    ></button>
                  </div>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5" class="empty-message" data-testid="empty-message">
                  <div class="empty-content">
                    <i class="pi pi-users empty-icon"></i>
                    <h3>No Authors Found</h3>
                    <p *ngIf="hasActiveFilters(); else noAuthorsTemplate">
                      No authors match your current filters. Try adjusting your search criteria.
                    </p>
                    <ng-template #noAuthorsTemplate>
                      <p >Start building your authors library by adding your first author.</p>
                      <button
                        pButton
                        type="button"
                        label="Add First Author"
                        icon="pi pi-plus"
                        class="p-button-primary"
                        routerLink="/authors/new"
                        data-testid="add-first-author-button"
                      ></button>
                    </ng-template>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </p-card>
    </div>
  </div>
</div>
`
