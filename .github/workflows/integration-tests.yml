name: Integration Tests (API)

on:
  workflow_dispatch:
    inputs:
      cucumber_tags:
        description: "Select the Cucumber tag suite to run"
        required: true
        type: choice
        options:
          - "@smoke"
          - "@regression"
          - "@integration"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  integration-tests:
    runs-on: ubuntu-latest

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v3

  - name: Start backend stack
    run: |
      echo "Starting backend stack..."
      docker compose \
        --env-file ./config/.env.dev \
        -f docker-compose.yml \
        up -d --build db backend

  - name: Run API Tests and generate Allure results
    # Use 'always()' here so the cleanup step always runs.
    if: always()
    run: |
      # The maven command runs and generates XML/JSON results in api-tests/target/allure-results
      docker compose \
        --env-file ./config/.env.dev \
        -f docker-compose.yml \
        run --rm api-tests sh -c "
          cd /api-tests && \
          mvn clean test \
            -Dcucumber.filter.tags='${{ github.event.inputs.cucumber_tags }}' \
            -Dallure.results.directory=target/allure-results \
            -Dmaven.test.failure.ignore=true
        "

  - name: Upload Allure JSON results (Raw data)
    # We upload the raw results here. This artifact is used by the next job.
    uses: actions/upload-artifact@v4
    if: always()
    with:
      name: allure-results-api-raw
      path: api-tests/target/allure-results
      retention-days: 7 # Keep raw data for a week

  - name: Stop stack
    if: always()
    run: |
      echo "Stopping Docker stack..."
      docker compose -f docker-compose.yml down
